define("app/exts/auth/lib/field/field",["require","module","exports","jquery","underscore","app/exts/arale/base","app/exts/auth/lib/rule/rule","app/exts/auth/lib/rule/ruleFactory","app/exts/auth/lib/utils"],function(e,t,r){function a(e){var t=o.rules,r={},a=e.attr("test-rules");if(a){var n={};i.each(a.split(","),function(e){t[e]&&(n[e]=t[e])}),t=n}return i.each(t,function(t,a){void 0!=e.attr(a)&&(r[a]={msg:{error:e.attr(a+"-msg"),success:e.attr(a+"-success-msg")||g,warn:e.attr(a+"-warn-msg")||g},propertyValue:e.attr(a)})}),r}function n(e){var t={};if(!(e=u(e))||!e.length)return t;var r=a(e);u.isEmptyObject(r)||(t.rules=r);var n=e.attr("auth-event");return n&&(t.event=n),t}var u=e("jquery"),i=e("underscore"),s=e("app/exts/arale/base"),l=e("app/exts/auth/lib/rule/rule"),o=e("app/exts/auth/lib/rule/ruleFactory"),c=e("app/exts/auth/lib/utils"),g="",f={event:"blur",style:{success:"ok",error:"error"}},v=s.extend({Statics:{_defer:new u.Deferred},initialize:function(e,t){var r=this;r._validateDone={},r._cache={};var a=n(e);i.extend(t,f),i.extend(t,a),i.extend(t,{target:e}),r._cfg=t,r._storage={},v.superclass.initialize.call(r,t),r._init()},_init:function(){var e=this,t=e._cfg,r=e.get("target"),a=i.extend({},t.rules);e._groupTarget(),i.each(a,function(t,r){!e._storage[r]&&o.rules[r]&&e._createRule(r,t)}),r.data("data-field",e);var n=r[0];return e._targetBind(t.event||c.getEvent(n)),e.trigger("render"),e},_groupTarget:function(){var e=this,t=e.get("target");if(-1!=u.inArray(t.attr("type"),["checkbox","radio"])){var r=t[0].form,a=t.attr("name"),n=[];i.each(document.getElementsByName(a),function(e){e.form==r&&n.push(e)}),t=u(n),e.set("target",t)}return t},_targetBind:function(e){var t=this,r=t.get("target");return!!r.length&&(r.on(e,function(){setTimeout(function(){t.validate()},0)}),t)},_createRule:function(e,t){var r=this,a=r.get("target");i.extend(t,{value:a.val(),target:a,field:r});var n=o.create(e,t);return r.add(e,n),n},add:function(e,t){var r=this,a=r._storage;return t instanceof l?a[e]=t:S.isFunction(t)&&(a[e]=new l(e,t)),r.set("rules",a),r},remove:function(e){var t=this._storage;return delete t[e],self.set("rules",t),this},rule:function(e){return this.get("rules")[e]},test:function(e){return this.validate(e)},validate:function(e){var t=this,r=[],a=t.get("rules");if(i.isString(e)){var n=e.split(",");i.each(n,function(e){a[e]&&r.push(a[e])})}else i.each(a,function(e){r.push(e)});var s=t.get("exclude");if(""!=s){var l=s.split(",");r=i.filter(r,function(e){return!(-1!=u.inArray(e.get("name"),l))})}if(!t.get("hiddenTest")){t.get("target").attr("disabled")&&(r=[])}var o=new u.Deferred;if(!r.length){var c=new u.Deferred,g=c.promise();return g.then(function(){o.resolve(r),t.trigger("success",{rules:r,target:t})}),c.resolve(),g}t.trigger("beforeTest",{rules:r});var f=new u.Deferred;f.resolve(!0);var v=f.promise();return i.each(r,function(e){v=v.then(function(t){return e.validate()})}),v.then(function(){o.resolve(r),t.trigger("success",{rules:r,target:t})}).fail(function(e){o.reject(e),console.log&&console.log(t.get("name")+"\u5b57\u6bb5\u51fa\u9519\u7684\u89c4\u5219\u662f\uff1a"+e.get("name")),t.trigger("error",{rule:e})}),o.promise()},destroy:function(){var e=this,t=e.get("target"),r=e._cfg;t.off(r.event||c.getEvent(target[0])),t.removeData("data-field")},attrs:{target:{value:"",getter:function(e){return u(e)},setter:function(e){var t=u(e),r=this,a=r.get("rules");return u.isEmptyObject(a)||(i.each(a,function(e){e.set&&e.set("target",t)}),t.data("data-field",r)),t}},name:{value:""},event:{value:"",setter:function(e){return this._targetBind(e),e}},host:{value:""},exclude:{value:""},rules:{value:{}},msg:{value:""}}});return v});