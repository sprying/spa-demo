define("app/exts/auth/auth",["require","module","exports","jquery","underscore","app/exts/arale/base","app/exts/auth/lib/field/field","app/exts/auth/rule/ruleFactory","app/exts/auth/lib/utils"],function(e,t,r){var i=e("jquery"),n=e("underscore"),a=e("app/exts/arale/base"),s=e("app/exts/auth/lib/field/field"),u=e("app/exts/auth/rule/ruleFactory"),l=e("app/exts/auth/lib/utils"),o=a.extend({Statics:{_defer:new i.Deferred},initialize:function(e,t){var r=this;t||(t={}),e&&n.extend(t,{target:e}),r._storages={},r.AuthConfig=t,o.superclass.initialize.call(r,t)},render:function(){var e=this,t=e.get("target");if(!t.length)return e;var r=t[0].elements;if(!r.length)return e;var a=e.get("fnFilter");return n.each(r,function(t){var r=i(t);if(n.isFunction(a)&&a.call(e,r))return!0;var s=r.attr("type"),u=["BUTTON"],l=t.tagName;if(-1!=i.inArray(l,u))return!0;if("submit"==s)return!0;"SELECT"==l&&r.attr("data-type","select");var o=["radio","checkbox"];if(-1!=i.inArray(s,o)&&r.data("data-field"))return!0;e.add(t)}),t.attr("novalidate","novalidate"),e._submit(),e.trigger("render"),e},_submit:function(){var e=this;if(!e.get("submitTest"))return e;var t=e.get("target");return t.on("submit",function(t){t.preventDefault(),e.test()}),e.on("success",function(){t[0].submit()}),e},add:function(e,t){var r,a,u=this,o="";if(e instanceof s)r=e.get("target"),a=u.getName(r),o=u._storages[a||l.guid()]=e;else{var f=u.get("autoBind");if(r=i(e),!r.length)return!1;a=u.getName(r);var g={event:f?l.getEvent(r):"",host:u,name:a};n.extend(g,t);var d=u.get("fnConfig");n.isFunction(d)&&(g=d.call(u,g,r)),o=u._storages[a]=new s(r,g)}return u.trigger("add",{field:o}),o},remove:function(e){var t=this;return e?t._storages[e]?(delete t._storages[e],console.log&&console.log("\u5220\u9664"+e+" field"),t):void 0:t},getName:function(e){if(!e||!e.length)return"";var t=this,r=l.guid(),i=t.get("useId");return i?e.attr("id")||e.attr("name")||r:e.attr("name")||e.attr("id")||r},fieldTarget:function(e){if(!e)return!1;var t=this,r=t.field(e);return!!r&&r.get("target")},field:function(e){return this.getField(e)},getField:function(e){return this._storages[e]},register:function(e,t){return u.register(e,t),this},test:function(e){return this.validate(e)},validate:function(e){function t(e){if(f>=s.length)return o.then(function(){g.length||(r.set("hasError",!1),r.set("errorFields",[]),a.resolve(s),r.trigger("success",{fields:s}))}).fail(function(){a.reject(g),r.trigger("error",{fields:g})}),o;o=e.test(),f++,o.then(function(){t(s[f])}).fail(function(e){g.push(e.get("field")),r.set("errorFields",g),r.set("hasError",!0),n?(a.reject(g),r.trigger("error",{fields:g})):t(s[f])})}var r=this,n=r.get("stopOnError"),a=new i.Deferred,s=r._filterFields(e);if(!s.length){var u=new i.Deferred,l=u.promise();return l.then(function(){a.resolve(s),r.trigger("success",{fields:s})}),u.resolve(),l}var o,f=0,g=[];return r.trigger("beforeTest",{fields:s}),t(s[f]),a.promise()},_filterFields:function(e){var t=this,r=t.get("fields");if(e){var a=e.split(",");a.length>0&&(e=n.filter(r,function(e){return-1!=i.inArray(e.get("name"),a)}))}else e=r;return e=n.filter(e,function(e){var t=e.get("rules");return!i.isEmptyObject(t)})},destroy:function(){n.each(this.get("fields"),function(e){e.destroy()})},attrs:{target:{value:"",getter:function(e){return i(e)}},rules:{value:{},getter:function(e){return u.rules}},fields:{value:[],getter:function(e){var t=this,r=t._storages,i=[];return n.each(r,function(e){i.push(e)}),i}},fnFilter:{value:""},fnConfig:{value:""},useId:{value:!1},autoBind:{value:!0},stopOnError:{value:!1},submitTest:{value:!0},hasError:{value:!1},errorFields:{value:[]}}});return n.extend(o,{Field:s}),o});